#!/usr/bin/env bash

set -euo pipefail

main() {
	local region ami

	region="$(jq -re '.builds | last | .artifact_id' "${1}" | cut -d ':' -f 1)"
	ami="$(jq -re '.builds | last | .artifact_id' "${1}" | cut -d ':' -f 2)"

	local stage="${2:-staging}"

	echo "Deploying ${ami} to ${stage} in ${region}"

	exec ansible-playbook pipeline/deploy-stack.yml \
		--extra-vars "ami=${ami}" \
		--extra-vars "region=${region}" \
		--extra-vars "stage=${stage}"
}

main "$@"
